---
layout: post
title: 7年近く動いていた自作サーバの1台が壊れた
categories:
- Other
---
自宅を建ててから8年くらい経過してますが、引っ越したあとくらいから今までずっと動いていた自作サーバの1台が先週金曜日の夜に壊れました。

![my_server_1.png]({{ "/images/2016/03/my_server_1.jpg" | prepend: site.baseurl }})

裏面はこんな感じ。USB3.0の拡張ボードが刺さってます。

![my_server_2.png]({{ "/images/2016/03/my_server_2.jpg" | prepend: site.baseurl }})

そして中はこんな感じ。

![my_server_3.png]({{ "/images/2016/03/my_server_3.jpg" | prepend: site.baseurl }})

CPUはAMDの[Athlon II X4 605e](http://pc.watch.impress.co.jp/docs/column/tawada/20090918_316192.html)で、消費電力45Wなのにそこそこの性能持ってたのに惹かれて選びました。メモリはDDR3-1333の4GBx2。650GBのHDD、という構成です。マザーボードは・・・覚えていません。

壊れる前のサーバの構成は以下でした。

![my_server_4.png]({{ "/images/2016/03/my_server_4.png" | prepend: site.baseurl }})

FreeNASサーバにkvmのイメージを置いて、NFSで2つのサーバからマウントしています。つまり、FreeNASサーバが死亡したら全部アウトなんですけど、FreeNASサーバさえ生きてれば、他の2つのサーバが死んでも各VMは生き残ります。で、VMのイメージファイルが消えると結構やばいので、RAID-Z2組んでディスクが2本同時に死んでも大丈夫なようにしています。実際、Seagate x 2 + WesternDigital x 2を最初使ってて、かなり短い期間でSeagateがどっちもお亡くなりになる、という経験をしてて、交換の時はやっぱりヒヤヒヤするので、RAID-Z2組んでおいて良かったな、と。

先週の金曜日の夜（正確には土曜日になってた）24:30くらいに、停電が発生。すぐに復帰したんだけど、UPSなんてやってないので、3台とも電源が落ちてた。停電には気がつかなかったので、ネットにつながらないことに気がついたのは朝。ルーターにはPingが通るので、あ、停電でもあったかな、と。

サーバがあるリビングに行って、3台の電源を入れたら・・・ネットは再開。基本的には、上図の左のサーバとFreeNASサーバが復活すれば、ネットはできようになるので。

ただ、右のサーバから、なんかCPUファンが「ぶおぉぉん、（沈黙）、ぶおぉぉん、（沈黙）・・・」を繰り返しているような音がしてる。おかしいと思ってモニタを繋いでみると、信号が何も来てない。HDDのディスクが回っている音もしない。電ぷちして再度電源入れてみると、CPUファンは普通に回り始めたけど、BIOSが起動してくる気配がない。

何度か電源入れ直してみたけど、改善する兆しはなし。この時点で死亡確定診断しました。

さて、この後どうするか、ですが、3つの選択肢を考えました。

1. 新しいマザーボードとCPUを買ってきて、自作サーバを復活させる。
1. 壊れた自作サーバで動かしていたVMは、AWS EC2に移行する。
1. その他

まず「自作サーバを復活させる」は、早々にNGにしました。一番楽な選択肢なのですが、「お金がかかる」「買いに行くのが面倒」「本当にマザーボードとCPUを買い直せば良いのか調査が必要」ということもあって、やめようかなと。

なので、次の選択肢「クラウドに移行する」を今回は最終的に選択したいな、と考えました。実際今までクラウドって敬遠していてほとんど経験なかったりするので、今回は良いきっかけかな、と。実際、AWS関連の書籍を探しに本屋に行ってきたし、AWSの管理コンソールを使えるようにいろいろ手続きして「インスタンス作る手前」までは来ました。あとは、ボタンポチッとするだけ。。。

ここで思いました。「とりあえず壊れてしまったVMをどこかで動かさないと」。ふと壊れた自作サーバに目をやった瞬間、「メモリは生きてるのでは？」と気が付きました。

生きてる自作サーバのメモリは、4GBx2と2GBx2の12GB構成。その中途半端な2GBx2を抜いてしまって、壊れた自作サーバに刺さってた4GBx2を使えば、合計16GBになります。さっそく差し替えて、無事16GBと認識されたので、FreeNASにあるVMを生きてるサーバで起動しました。16GBに増えたおかげで、6個のVMは順調に動作をしています。

結局、「その他」になりました。自作サーバを直すわけでもなく、クラウドを使いはじめるわけでもなく、なんと「生きてる自作サーバのスケールアップ」。構成図は以下になりました。

![my_server_5.png]({{ "/images/2016/03/my_server_5.png" | prepend: site.baseurl }})

現状の稼働状況を見てみると、メモリもあと6GB空いてますし、CPUもスカスカです。良い感じです。

![my_server_6.png]({{ "/images/2016/03/my_server_6.png" | prepend: site.baseurl }})

とりあえず「直ちに影響はない」というレベルの対処はできました。クラウド関連の技術がまた遠のいてしまいましたが、近々時間を作ってクラウド移行にチャレンジしてみたいと思います。今度は必ず・・・。
